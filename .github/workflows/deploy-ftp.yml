name: üöÄ Smart WooCommerce CI/CD to Hostinger via FTP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  detect_changes:
    name: üîç Detect changed folders
    runs-on: ubuntu-latest
    outputs:
      theme_changed: ${{ steps.detect.outputs.theme_changed }}
      plugin_changed: ${{ steps.detect.outputs.plugin_changed }}
    steps:
      - name: üß© Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # c·∫ßn ƒë·ªÉ diff commit

      - name: üîé Detect changes in theme/plugin folders
        id: detect
        run: |
          # Ki·ªÉm tra c√≥ thay ƒë·ªïi trong theme kh√¥ng
          if git diff --name-only HEAD~1 HEAD | grep -q "wp-content/themes/flatsome-child/"; then
            echo "theme_changed=true" >> $GITHUB_OUTPUT
          else
            echo "theme_changed=false" >> $GITHUB_OUTPUT
          fi

          # Ki·ªÉm tra c√≥ thay ƒë·ªïi trong plugin kh√¥ng
          if git diff --name-only HEAD~1 HEAD | grep -q "wp-content/plugins/woocommerce/"; then
            echo "plugin_changed=true" >> $GITHUB_OUTPUT
          else
            echo "plugin_changed=false" >> $GITHUB_OUTPUT
          fi

  deploy_theme:
    name: üé® Deploy Theme
    needs: detect_changes
    if: needs.detect_changes.outputs.theme_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: üß© Checkout source
        uses: actions/checkout@v4

      # (T√πy ch·ªçn) build theme n·∫øu c·∫ßn
      # - name: üîß Build theme assets
      #   run: npm install && npm run build

      - name: üì§ Upload WooCommerce Theme via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          port: 21
          local-dir: ./wp-content/themes/flatsome-child/
          server-dir: /httpdocs/wp-content/themes/flatsome-child/
          exclude: |
            **/.git*
            **/.github*
            node_modules/**
            .DS_Store
            package-lock.json

  deploy_plugin:
    name: ‚öôÔ∏è Deploy Plugin
    needs: detect_changes
    if: needs.detect_changes.outputs.plugin_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: üß© Checkout source
        uses: actions/checkout@v4

      # (T√πy ch·ªçn) build plugin n·∫øu c·∫ßn
      # - name: üîß Build plugin
      #   run: npm install && npm run build

      - name: üì§ Upload WooCommerce Plugin via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftp
          port: 21
          local-dir: ./wp-content/plugins/woocommerce/
          server-dir: /httpdocs/wp-content/plugins/woocommerce/
          exclude: |
            **/.git*
            **/.github*
            node_modules/**
            .DS_Store
